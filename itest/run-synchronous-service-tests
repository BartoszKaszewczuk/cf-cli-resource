#!/bin/bash

set -eu
set -o pipefail

test_dir=$(dirname $0)

source $test_dir/helpers.sh
source $test_dir/config.sh

org=$(generate_org_name)
space=$(generate_space_name)
app_name=$(generate_app_name)

service=$SYNC_SERVICE
plan=$SYNC_PLAN
service_instance=$testprefix-sync_service-$timestamp
configuration=$SYNC_CONFIGURATION

setup_integration_tests "$org" "$space"

run it_can_push_an_app \"$org\" \"$space\" \"$app_name\"

run it_can_create_a_service \"$org\" \"$space\" \"$service\" \"$plan\" \"$service_instance\" \"$configuration\"
# run again to prove that it won't error out if it already exists
run it_can_create_a_service \"$org\" \"$space\" \"$service\" \"$plan\" \"$service_instance\" \"$configuration\"

run it_can_bind_a_service \"$org\" \"$space\" \"$app_name\" \"$service_instance\"
run it_can_unbind_a_service \"$org\" \"$space\" \"$app_name\" \"$service_instance\"
run it_can_delete_a_service \"$org\" \"$space\" \"$service_instance\"

run it_can_delete_an_app \"$org\" \"$space\" \"$app_name\"

teardown_integration_tests "$org" "$space"
